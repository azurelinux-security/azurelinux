From 9bb5ff1441965feace7451482dc5576a6a2dff24 Mon Sep 17 00:00:00 2001
From: Azure Linux Security Servicing Account
 <azurelinux-security@microsoft.com>
Date: Tue, 15 Jul 2025 16:46:01 +0000
Subject: [PATCH] Fix CVE CVE-2025-7345 in gdk-pixbuf2

Upstream Patch Reference: https://gitlab.gnome.org/GNOME/gdk-pixbuf/-/merge_requests/217.patch
---
 gdk-pixbuf/io-jpeg.c.rej | 28 ++++++++++++++++++++++++++++
 1 file changed, 28 insertions(+)
 create mode 100644 gdk-pixbuf/io-jpeg.c.rej

diff --git a/gdk-pixbuf/io-jpeg.c.rej b/gdk-pixbuf/io-jpeg.c.rej
new file mode 100644
index 0000000..40164af
--- /dev/null
+++ b/gdk-pixbuf/io-jpeg.c.rej
@@ -0,0 +1,28 @@
+--- io-jpeg.c
++++ io-jpeg.c
+@@ -359,6 +359,7 @@ jpeg_parse_exif_app2_segment (JpegExifContext *context, jpeg_saved_marker_ptr ma
+ 		context->icc_profile = g_new (gchar, chunk_size);
+ 		/* copy the segment data to the profile space */
+ 		memcpy (context->icc_profile, marker->data + 14, chunk_size);
++                ret = TRUE;
+ 		goto out;
+ 	}
+ 
+@@ -380,12 +381,15 @@ jpeg_parse_exif_app2_segment (JpegExifContext *context, jpeg_saved_marker_ptr ma
+ 	/* copy the segment data to the profile space */
+ 	memcpy (context->icc_profile + offset, marker->data + 14, chunk_size);
+ 
+-	/* it's now this big plus the new data we've just copied */
+-	context->icc_profile_size += chunk_size;
++        context->icc_profile_size = MAX (context->icc_profile_size, offset + chunk_size);
+ 
+ 	/* success */
+ 	ret = TRUE;
+ out:
++        if (!ret) {
++                g_free (context->icc_profile);
++                context->icc_profile = NULL;
++        }
+ 	return ret;
+ }
+ 
-- 
2.45.3

