From 5c7bec2d59bef1612f7a1f0a1acaa812572b92ee Mon Sep 17 00:00:00 2001
From: Azure Linux Security Servicing Account
 <azurelinux-security@microsoft.com>
Date: Tue, 1 Jul 2025 11:42:19 +0000
Subject: [PATCH] Fix CVE CVE-2025-52939 in ceph

[AI Backported] Upstream Patch Reference: https://github.com/lua/lua/commit/42d40581dd919fb134c07027ca1ce0844c670daf
---
 src/civetweb/src/third_party/lua-5.3.3/src/lvm.c | 6 ++++--
 1 file changed, 4 insertions(+), 2 deletions(-)

diff --git a/src/civetweb/src/third_party/lua-5.3.3/src/lvm.c b/src/civetweb/src/third_party/lua-5.3.3/src/lvm.c
index 84ade6b2f..35d0b6af6 100644
--- a/src/civetweb/src/third_party/lua-5.3.3/src/lvm.c
+++ b/src/civetweb/src/third_party/lua-5.3.3/src/lvm.c
@@ -490,8 +490,10 @@ void luaV_concat (lua_State *L, int total) {
       /* collect total length and number of strings */
       for (n = 1; n < total && tostring(L, top - n - 1); n++) {
         size_t l = vslen(top - n - 1);
-        if (l >= (MAX_SIZE/sizeof(char)) - tl)
+        if (l >= (MAX_SIZE/sizeof(char)) - tl) {
+          L->top = top - total;  /* pop strings to avoid wasting stack */
           luaG_runerror(L, "string length overflow");
+        }
         tl += l;
       }
       if (tl <= LUAI_MAXSHORTLEN) {  /* is result a short string? */
@@ -506,7 +508,7 @@ void luaV_concat (lua_State *L, int total) {
       setsvalue2s(L, top - n, ts);  /* create result */
     }
     total -= n-1;  /* got 'n' strings to create 1 new */
-    L->top -= n-1;  /* popped 'n' strings and pushed one */
+    L->top = top - (n - 1);  /* popped 'n' strings and pushed one */
   } while (total > 1);  /* repeat until only 1 result left */
 }
 
-- 
2.45.3

